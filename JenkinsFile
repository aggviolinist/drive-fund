pipeline {
    agent none

    environment {
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
    }

    stages {
        stage('Build and Test') {
            agent {
                docker {
                    image 'maven:3.9.6-eclipse-temurin-17'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                sh 'ls -ltr'
                withAWS(credentials: 'aws-jenkins-creds', region: 'us-east-1') {
                    sh '''
                        apt-get update && apt-get install -y awscli || true
                        aws --version
                        aws sts get-caller-identity
                        mvn clean package
                    '''
                }
            }
        }

        stage('Static Code analysis'){
            agent{
                docker{
                image 'maven:3.9.6-eclipse-temurin-17'
                args '--user root'
                }
            }
            environment{
                SONAR_URL = "http://54.221.68.152:9000"
            }
            steps{
                withCredentials([string(credentialsId: 'sonarqube',variable:'SONAR_AUTH_TOKEN')]){
                    sh '''
                    mvn sonar:sonar \
                        -Dsonar.login=$SONAR_AUTH_TOKEN \
                        -Dsonar.host.url=$SONAR_URL
                    '''
                }
            }
        }

        stage('Build and Push Docker Image') {
            agent {
                docker {
                    image 'docker:25.0.3-cli'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            environment {
                DOCKER_IMAGE = "violinist999/ripper:${BUILD_NUMBER}"
            }
            steps {
                sh '''
                    echo "Cleaning up old Docker data..."
                    docker system prune -af --volumes || true

                    echo "Building image ${DOCKER_IMAGE}"
                    docker build -t ${DOCKER_IMAGE} .

                    echo "Pushing image to Docker Hub..."
                '''
                script {
                    def dockerImage = docker.image("${DOCKER_IMAGE}")
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-creds') {
                        dockerImage.push()
                    }
                }
            }
        }

        stage('Update Deployment File') {
            agent{
                docker{
                    image 'ubuntu:latest'
                    args '--user root -v /var/run/docker.sock:/var/run/docker.sock'

                }
            }
            environment {
                GIT_REPO_NAME = "drive-fund"
                GIT_USER_NAME = "aggviolinist"
                GIT_BRANCH = "main"
            }
            steps {
                withCredentials([string(credentialsId: 'github-creds', variable: 'GITHUBTOKEN')]) {
                    sh '''
                        apt-get update -y
                        apt-get install -y git
                        git config --global --add safe.directory /var/lib/jenkins/workspace/Jenkins-Learning-Path
                        git clean -fd
                        git pull origin ${GIT_BRANCH}
                        git checkout ${GIT_BRANCH}
                        git config user.email "mulandimaei76@gmail.com"
                        git config user.name "aggviolinist"
                        if [ -f kubernetes/deployment.yml ]; then
                            sed -i "s/replaceThisImageTag/${BUILD_NUMBER}/g" kubernetes/deployment.yml
                        else
                            echo "ERROR: kubernetes/deployment.yml not found!"
                            exit 1
                        fi
                        git add kubernetes/deployment.yml
                        git diff --cached --exit-code || git commit -m "Updated with latest Docker image tag ${BUILD_NUMBER}"
                        git pull --rebase origin ${GIT_BRANCH} 
                        git push https://${GITHUBTOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:${GIT_BRANCH}
                    '''
                }
            }
        }
    }
}
