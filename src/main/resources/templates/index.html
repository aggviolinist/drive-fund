<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Savings Deposit Tester</title>
    <meta id="plan-uuid" content="34d2137f-50ff-4601-9343-e49d983acc3b">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        .success { color: green; border: 1px solid green; padding: 10px; margin: 10px 0;}
        .error { color: red; border: 1px solid red; padding: 10px; margin: 10px 0; }
        .response-box { border: 1px solid #ccc; padding: 15px; margin-top: 15px; }
        #send-form { margin-bottom: 20px; padding: 10px; border: 1px dashed #007bff; }
    </style>
</head>
<body>
    <h1>Real-Time Savings Deposit Tester</h1>
    <p>Testing Plan: <strong id="plan-id-display">Loading...</strong></p> 
    <div id="connection-status">Not Connected</div>

    <div id="send-form">
        <h2>Make a Deposit (Test)</h2>
        <label for="deposit-amount">Deposit Amount:</label>
        <input type="number" id="deposit-amount" placeholder="e.g., 100.00" value="500" step="0.01">
        <br><br>
        <button onclick="sendDeposit()">Send Deposit</button>
    </div>

    <div id="withdraw-form">
        <h2>Withdrawal (Test)</h2>
        <label for="withdraw-amount">Withdraw Amount:</label>
        <input type="number" id="withdraw-amount" placeholder="e.g., 50.00" value="100" step="0.01">
        <br><br>
        <button onclick="sendWithdrawal()">Withdraw This Amount</button>
    </div>

    <h2>Latest Savings Progress:</h2>
    <div id="progress-display">Waiting for deposit...</div>

    <script th:inline = "javascript">
        /*<![CDATA[*/
        const planUuid = /*[[${planUuid}]]*/ 'ERROR_NO_UUID';
        document.getElementById('plan-id-display').textContent = planUuid;
        //const SOCKET_URL = '/web/sockets'; //for connnecting with Angular
        const SOCKET_URL = 'http://localhost:8081/ws'; // for local testing
        //const SOCKET_URL = 'https://drive-fund.onrender.com/ws';
        const PROGRESS_TOPIC = `/topic/progress/${planUuid}`; // Matches @SendTo to enable Subscription
        const DEPOSIT_DESTINATION = `/app/deposit/${planUuid}`; // Matches /app prefix + @MessageMapping destination where data is sent to
        const WITHDRAW_DESTINATION = `/app/withdrawal/${planUuid}`; //Destination data is sent
        /*]]>*/

        let stompClient = null;

        // --- Utility Functions ---

        function updateStatus(message, isError = false) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = message;
            statusElement.style.color = isError ? 'red' : 'green';
        }

        // --- UPDATED displayProgress FUNCTION ---
        function displayProgress(progressJson) {
            const display = document.getElementById('progress-display');
            
            try {
                // Now parsing the COMBINED DTO: DepositConfirmationDTO
                const combinedResponse = JSON.parse(progressJson);

                 
                
                // Handle the custom error message from the server
                if (combinedResponse.error) {
                    display.innerHTML = `<div class="error">Server Error: ${combinedResponse.error}</div>`;
                    return;
                }

                //Make payment only on deposit DTO
                const isDepositResponse = combinedResponse.paymentResponse !== undefined;

                // Destructure the nested DTOs for easier access
                //const payment = combinedResponse.paymentResponse;
                const progress = combinedResponse.savingsProgressResponse;
                //const withdraw = combinedResponse.socketWithdrawalResponse;

                // const progress = isDepositResponse
                //    ? combinedResponse.savingsProgressResponse
                //    : combinedResponse.savingsProgressResponse;

                const DepositOrWithdrawalMessage = combinedResponse.message;

                //Start building the display HTML
                let html = `<div class="response-box" ${isDepositResponse ? 'success' : `error`}>`;
                    html += `<h3>Transaction Update: ${DepositOrWithdrawalMessage}</h3><hr>`;

                if(isDepositResponse){
                    const payment = combinedResponse.paymentResponse;
                    html += `
                         <h4>Payment Details-Deposit</h4>
                         <p><strong>Payment ID:</strong> ${payment.paymentUuid}</p>
                         <p><strong>Amount Deposited:</strong> <strong style="color:blue;"> ${payment.paymentAmount}</strong></p>
                         <p><strong>Date: </strong> ${payment.payment_date} </p>
                         <p><strong> Status: </strong> ${payment.status} </p>
                         `;
                }
                else{
                    //Withdrawal Response (SocketWithdrawalDetailsResponse)
                    const withdrawalAmount = combinedResponse.withdrawnAmount;
                    const withdrawalDate = combinedResponse.withdrawalDate;
                    html += `<h4>Withdrawal Details</h4>
                         <p><strong>Amount withdrawn:</strong> <strong style="color: red;">${withdrawalAmount}</strong></p>
                         <p><strong>Date: </strong> ${withdrawalDate}</p>
                         <p>Note: Transaction fees/penalties were applied and are reflected in the total deposit balance below.</p>
                        <hr>
                        `;
                }
                
                // Format the output to be readable
                html += `                        
                        <h4>Updated Savings Progress</h4>
                        <p><strong>Goal:</strong> ${progress.productName}</p>
                        <p><strong>Total Deposited:</strong> <strong style="color: green;">$${progress.paidTillToday}</strong></p>
                        <p><strong>Balance Remaining:</strong> $${progress.remainingAmount}</p>
                        <p><strong>Progress:</strong> ${progress.percentageCompleted}% Completed</p>
                        <p><strong>Next Expected Payment:</strong> $${progress.newExpectedPayment} per ${progress.frequency ? progress.frequency.toLowerCase() : 'period'}</p>
                        <p><strong>Note:</strong> ${progress.note}</p>
                        <p><strong>Countdown:</strong> ${progress.timeRemaining}</p>
                        <hr>
                        
                        <details>
                            <summary>View Full JSON Response</summary>
                            <pre>${JSON.stringify(combinedResponse, null, 2)}</pre>
                        </details>
                    </div>
                `;
                display.innerHTML = html
            } catch (e) {
                console.error("Error parsing/displaying response:", e);
                display.innerHTML = `<div class="error">Received invalid data: <pre>${progressJson}</pre></div>`;
            }
        }
        // --- END UPDATED displayProgress FUNCTION ---


        // --- Connection Logic ---

        function connect() {
            const socket = new SockJS(SOCKET_URL); // SockJS handles fallbacks
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                updateStatus('Connected to Spring Boot Server', false);
                console.log('Connected: ' + frame);
                
                // Subscribe to the topic where the server sends the progress update
                //progressMessage is the container for data sent from the socket
                stompClient.subscribe(PROGRESS_TOPIC, function (progressMessage) {
                    // progressMessage.body is the JSON string from the server
                    displayProgress(progressMessage.body); 
                });

            }, function (error) {
                updateStatus('Connection Error: ' + error, true);
                console.error('WebSocket connection error: ' + error); 
            });
        }

        // --- Sending Deposit Logic ---

        function sendDeposit() {
            const amountInput = document.getElementById('deposit-amount');
            const paymentAmount = parseFloat(amountInput.value);

            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                alert("Please enter a valid deposit amount.");
                return;
            }
              // Check if UUID was successfully loaded
            if (planUuid === 'ERROR_NO_UUID') {
                alert("Error: Could not determine Savings Plan ID. Reload the page with the correct UUID in the URL.");
                return;
            }

            if (stompClient && stompClient.connected) {
                // Construct the JSON message payload expected by the Spring controller
                // The key must match the 'amount' field in your SocketPaymentRequest DTO
                const depositMessage = JSON.stringify({ 'paymentAmount': paymentAmount });

                // Send the JSON string to the Spring @MessageMapping destination
                stompClient.send(DEPOSIT_DESTINATION, {}, depositMessage); 
                console.log("Sent deposit message to " + DEPOSIT_DESTINATION + ": " + depositMessage);
                
            } else {
                updateStatus("STOMP client not connected. Reconnecting...", true);
                connect(); // Try to reconnect if not connected
            }
        }

        //--Withdrawal Logic
        function sendWithdrawal(){
            const withdrawalInput  = document.getElementById('withdraw-amount')
            const withdrawnAmountz = parseFloat(withdrawalInput.value);

            if(isNaN(withdrawnAmountz) || withdrawnAmountz <= 0){
                alert("Please enter a valid amount to be withdrawn!");
                return;
            }
            //Was the UUID loaded successfully?
            if(planUuid === 'ERROR_NO_UUID'){
                alert("Error: Couldn't find the savings Plan. Reload the page to get correct UUID.");
                return;
            }
            if(stompClient && stompClient.connected){
                //Construct the JSON payload to be received Spring Controller
                const withdrawMessage = JSON.stringify({'withdrawnAmount':withdrawnAmountz});

                //Send JSON string to the new Spring @MessagingMapping destination
                stompClient.send(WITHDRAW_DESTINATION, {}, withdrawMessage);
                console.log("Sent withdrawal message to " + WITHDRAW_DESTINATION + ": " + withdrawMessage);

            }
            else{
                updateStatus("STOMP client not connected Reconnecting....", true);
                connect();
            }
        }

        // Initialize connection when the page loads
        connect();
    </script>
</body>
</html>
